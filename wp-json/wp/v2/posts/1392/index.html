{"id":1392,"date":"2022-03-10T06:54:33","date_gmt":"2022-03-10T06:54:33","guid":{"rendered":"http:\/\/localhost\/wordpress\/promisifying-css-animation-with-timeout-fallback\/"},"modified":"2022-03-10T06:54:33","modified_gmt":"2022-03-10T06:54:33","slug":"promisifying-css-animation-with-timeout-fallback","status":"publish","type":"post","link":"http:\/\/localhost\/wordpress\/promisifying-css-animation-with-timeout-fallback\/","title":{"rendered":"Promisifying CSS animation with timeout fallback"},"content":{"rendered":"<p> <br \/>\n<\/p>\n<div data-article-id=\"1008712\" id=\"article-body\">\n<p>So I came across this interesting problem dealing with state updates and animations. I wanted to create a utility function that would execute a state update after an animation had finished but with a timeout fallback in case a developer forgot to animate the element.<\/p>\n<p>This is useful for React applications where you want to wait for a slide-out animation for your popup to complete before updating your state, causing your popup to be removed from the DOM.<\/p>\n<p>Let&#8217;s start with the first two problems<br \/>1) We need an event listener to listen for the CSS tranistionend event that is fired from the animated element. When it is triggered, call some function <code>fn<\/code>.<br \/>2) We need a timeout function as a fallback. When the timeout triggers, call some function <code>fn<\/code><\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">\/\/ 1<\/span>\n<span class=\"kd\">const<\/span> <span class=\"nx\">addTransitionEndListener<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">element<\/span><span class=\"p\">:<\/span> <span class=\"nx\">Element<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">:<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"k\">void<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n  <span class=\"nx\">element<\/span><span class=\"p\">.<\/span><span class=\"nx\">addEventListener<\/span><span class=\"p\">(<\/span><span class=\"dl\">\"<\/span><span class=\"s2\">transitionend<\/span><span class=\"dl\">\"<\/span><span class=\"p\">,<\/span> <span class=\"nx\">fn<\/span><span class=\"p\">);<\/span>\n<span class=\"p\">};<\/span>\n\n<span class=\"c1\">\/\/ 2<\/span>\n<span class=\"kd\">const<\/span> <span class=\"nx\">addTimeOut<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">duration<\/span><span class=\"p\">:<\/span> <span class=\"kr\">number<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">:<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"k\">void<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n  <span class=\"nx\">setTimeout<\/span><span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">,<\/span> <span class=\"nx\">duration<\/span><span class=\"p\">);<\/span>\n<span class=\"p\">};<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Next, we want to promisify these two functions inside <code>Promise.race<\/code> and apply our state update when either one of these two promises is settled. We will also add some convenience types.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"c1\">\/\/ 1<\/span>\n<span class=\"kd\">type<\/span> <span class=\"nx\">Effect<\/span> <span class=\"o\">=<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"k\">void<\/span><span class=\"p\">;<\/span>\n<span class=\"kd\">type<\/span> <span class=\"nx\">CallbackFn<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">f<\/span><span class=\"p\">:<\/span> <span class=\"nx\">Effect<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"k\">void<\/span><span class=\"p\">;<\/span>\n\n<span class=\"c1\">\/\/ 2<\/span>\n<span class=\"kd\">const<\/span> <span class=\"nx\">promisify<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">:<\/span> <span class=\"nx\">CallbackFn<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span>\n  <span class=\"k\">new<\/span> <span class=\"nb\">Promise<\/span><span class=\"p\">((<\/span><span class=\"nx\">resolve<\/span><span class=\"p\">,<\/span> <span class=\"nx\">reject<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n    <span class=\"nx\">fn<\/span><span class=\"p\">(()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n      <span class=\"nx\">resolve<\/span><span class=\"p\">(<\/span><span class=\"kc\">null<\/span><span class=\"p\">);<\/span>\n    <span class=\"p\">});<\/span>\n  <span class=\"p\">});<\/span>\n\n<span class=\"c1\">\/\/ 3<\/span>\n<span class=\"kd\">const<\/span> <span class=\"nx\">addTransitionEndListenerP<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">promisify<\/span><span class=\"p\">(<\/span>\n  <span class=\"nx\">addTransitionEndListener<\/span><span class=\"p\">(<\/span><span class=\"nx\">someElement<\/span><span class=\"p\">)<\/span>\n<span class=\"p\">);<\/span>\n<span class=\"kd\">const<\/span> <span class=\"nx\">addTimeOutP<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">promisify<\/span><span class=\"p\">(<\/span><span class=\"nx\">addTimeOut<\/span><span class=\"p\">(<\/span><span class=\"nx\">someDuration<\/span><span class=\"p\">));<\/span>\n\n<span class=\"c1\">\/\/ 4<\/span>\n<span class=\"nb\">Promise<\/span><span class=\"p\">.<\/span><span class=\"nx\">race<\/span><span class=\"p\">([<\/span><span class=\"nx\">addTransitionEndListenerP<\/span><span class=\"p\">,<\/span> <span class=\"nx\">addTimeOutP<\/span><span class=\"p\">]).<\/span><span class=\"k\">finally<\/span><span class=\"p\">(()<\/span> <span class=\"o\">=&gt;<\/span>\n  <span class=\"nx\">console<\/span><span class=\"p\">.<\/span><span class=\"nx\">log<\/span><span class=\"p\">(<\/span><span class=\"dl\">\"<\/span><span class=\"s2\">state update goes here<\/span><span class=\"dl\">\"<\/span><span class=\"p\">)<\/span>\n<span class=\"p\">);<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>There&#8217;s a lot to digest here so let&#8217;s go through it section by section.<\/p>\n<ol>\n<li>\n<code>Effect<\/code> represents a function with no return value. <code>CallbackFn<\/code> expects an <code>Effect<\/code> function as an argument and does not return anything. Both <code>addTransitionEndListener<\/code> and <code>addTimeOut<\/code> are of type <code>CallbackFn<\/code> after the first argument.<\/li>\n<li>The <code>promisify<\/code> function expects a <code>CallbackFn<\/code> and returns a Promise. We are passing in <code>resolve(null)<\/code> as the <code>Effect<\/code> fn as we do not care about returning anything from our Promise for now.<\/li>\n<li>Using <code>promisify<\/code>, we turn <code>addTransitionEndListener<\/code> and <code>addTimeOut<\/code> into something that returns a Promise.<\/li>\n<li>We use <code>Promise.race<\/code> and <code>finally<\/code> to perform our mock state update regardless of whether the <code>transitionend<\/code> event first first or <code>someDuration<\/code> passes first. <code>someDuration<\/code> and <code>someElement<\/code> are defined outside of here.<\/li>\n<\/ol>\n<p>After wiring all this up, we now have another problem. How do we remove the event listener or clear the timeout once either event happens? Keep in mind that <code>removeEventListener<\/code>requires a reference to the same function that was passed in to <code>addEventListener<\/code> and <code>clearTimeout<\/code>requires the interval id which is only returned when <code>setTimeout<\/code> is called.<\/p>\n<p>To solve this, let&#8217;s change the type of <code>CallbackFn<\/code> to return a <code>CleanupFn<\/code> which is a type alias for <code>Effect<\/code>.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"kd\">type<\/span> <span class=\"nx\">CleanupFn<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">Effect<\/span><span class=\"p\">;<\/span>\n<span class=\"kd\">type<\/span> <span class=\"nx\">CallbackFn<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">f<\/span><span class=\"p\">:<\/span> <span class=\"nx\">Effect<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"nx\">CleanupFn<\/span><span class=\"p\">;<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Next we will need to change <code>addTransitionEndListener<\/code> and <code>addTimeOut<\/code> to return a CleanupFn.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"kd\">const<\/span> <span class=\"nx\">addTransitionEndListener<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">element<\/span><span class=\"p\">:<\/span> <span class=\"nx\">Element<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">(<\/span>\n  <span class=\"nx\">fn<\/span><span class=\"p\">:<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"k\">void<\/span>\n<span class=\"p\">):<\/span> <span class=\"nx\">CleanupFn<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n  <span class=\"nx\">element<\/span><span class=\"p\">.<\/span><span class=\"nx\">addEventListener<\/span><span class=\"p\">(<\/span><span class=\"dl\">\"<\/span><span class=\"s2\">transitionend<\/span><span class=\"dl\">\"<\/span><span class=\"p\">,<\/span> <span class=\"nx\">fn<\/span><span class=\"p\">);<\/span>\n  <span class=\"k\">return<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n    <span class=\"nx\">element<\/span><span class=\"p\">.<\/span><span class=\"nx\">removeEventListener<\/span><span class=\"p\">(<\/span><span class=\"dl\">\"<\/span><span class=\"s2\">transitionend<\/span><span class=\"dl\">\"<\/span><span class=\"p\">,<\/span> <span class=\"nx\">fn<\/span><span class=\"p\">);<\/span>\n  <span class=\"p\">};<\/span>\n<span class=\"p\">};<\/span>\n\n<span class=\"kd\">const<\/span> <span class=\"nx\">addTimeOut<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">duration<\/span><span class=\"p\">:<\/span> <span class=\"kr\">number<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">:<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"k\">void<\/span><span class=\"p\">):<\/span> <span class=\"nx\">CleanupFn<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n  <span class=\"kd\">const<\/span> <span class=\"nx\">timeoutID<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">setTimeout<\/span><span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">,<\/span> <span class=\"nx\">duration<\/span><span class=\"p\">);<\/span>\n  <span class=\"k\">return<\/span> <span class=\"p\">()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"nx\">clearTimeout<\/span><span class=\"p\">(<\/span><span class=\"nx\">timeoutID<\/span><span class=\"p\">);<\/span>\n<span class=\"p\">};<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>We will also need to change promisify to return a pair of a Promise and a Cleanup function. We will then need to provide another function that wraps <code>Promise.race<\/code> so that it calls all the cleanup functions in the finally block.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code><span class=\"kd\">type<\/span> <span class=\"nx\">PromiseCleanup<\/span> <span class=\"o\">=<\/span> <span class=\"p\">[<\/span><span class=\"nb\">Promise<\/span><span class=\"o\">&lt;<\/span><span class=\"nx\">unknown<\/span><span class=\"o\">&gt;<\/span><span class=\"p\">,<\/span> <span class=\"nx\">CleanupFn<\/span><span class=\"p\">];<\/span>\n\n<span class=\"kd\">const<\/span> <span class=\"nx\">promisify<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span><span class=\"nx\">fn<\/span><span class=\"p\">:<\/span> <span class=\"nx\">CallbackFn<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n  <span class=\"kd\">let<\/span> <span class=\"na\">cleanupFn<\/span><span class=\"p\">:<\/span> <span class=\"nx\">Effect<\/span> <span class=\"o\">|<\/span> <span class=\"kc\">undefined<\/span><span class=\"p\">;<\/span>\n  <span class=\"k\">return<\/span> <span class=\"p\">[<\/span><span class=\"k\">new<\/span> <span class=\"nb\">Promise<\/span><span class=\"p\">((<\/span><span class=\"nx\">resolve<\/span><span class=\"p\">,<\/span> <span class=\"nx\">reject<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n    <span class=\"nx\">cleanupFn<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">fn<\/span><span class=\"p\">(()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n      <span class=\"nx\">resolve<\/span><span class=\"p\">(<\/span><span class=\"kc\">null<\/span><span class=\"p\">);<\/span>\n    <span class=\"p\">});<\/span>\n  <span class=\"p\">}),<\/span> <span class=\"nx\">cleanupFn<\/span> <span class=\"k\">as<\/span> <span class=\"nx\">Effect<\/span><span class=\"p\">]<\/span>\n<span class=\"p\">};<\/span>\n\n<span class=\"k\">export<\/span> <span class=\"kd\">const<\/span> <span class=\"nx\">promisifyRace<\/span> <span class=\"o\">=<\/span> <span class=\"p\">(<\/span>\n  <span class=\"nx\">promiseCleanups<\/span><span class=\"p\">:<\/span> <span class=\"nx\">PromiseCleanup<\/span><span class=\"p\">[]<\/span>\n<span class=\"p\">):<\/span> <span class=\"nb\">Promise<\/span><span class=\"o\">&lt;<\/span><span class=\"nx\">unknown<\/span><span class=\"o\">&gt;<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n  <span class=\"kd\">const<\/span> <span class=\"nx\">promises<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">promiseCleanups<\/span><span class=\"p\">.<\/span><span class=\"nx\">map<\/span><span class=\"p\">(([<\/span><span class=\"nx\">promise<\/span><span class=\"p\">,<\/span> <span class=\"nx\">_<\/span><span class=\"p\">])<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"nx\">promise<\/span><span class=\"p\">);<\/span>\n  <span class=\"kd\">const<\/span> <span class=\"nx\">cleanups<\/span> <span class=\"o\">=<\/span> <span class=\"nx\">promiseCleanups<\/span><span class=\"p\">.<\/span><span class=\"nx\">map<\/span><span class=\"p\">(([,<\/span> <span class=\"nx\">cleanup<\/span><span class=\"p\">])<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"nx\">cleanup<\/span><span class=\"p\">);<\/span>\n\n  <span class=\"k\">return<\/span> <span class=\"nb\">Promise<\/span><span class=\"p\">.<\/span><span class=\"nx\">race<\/span><span class=\"p\">(<\/span><span class=\"nx\">promises<\/span><span class=\"p\">).<\/span><span class=\"k\">finally<\/span><span class=\"p\">(()<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"p\">{<\/span>\n    <span class=\"nx\">cleanups<\/span><span class=\"p\">.<\/span><span class=\"nx\">forEach<\/span><span class=\"p\">((<\/span><span class=\"nx\">cleanup<\/span><span class=\"p\">)<\/span> <span class=\"o\">=&gt;<\/span> <span class=\"nx\">cleanup<\/span><span class=\"p\">());<\/span>\n  <span class=\"p\">});<\/span>\n<span class=\"p\">};<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Now we are free to use it like so:<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight typescript\"><code> <span class=\"nx\">promisifyRace<\/span><span class=\"p\">([<\/span><span class=\"nx\">transitionP<\/span><span class=\"p\">(),<\/span> <span class=\"nx\">durationP<\/span><span class=\"p\">()])<\/span>\n    <span class=\"p\">.<\/span><span class=\"k\">finally<\/span><span class=\"p\">(<\/span><span class=\"nx\">stateUpdate<\/span><span class=\"p\">)<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Github link: <a href=\"https:\/\/github.com\/wibily\/promisifyCleanup\">https:\/\/github.com\/wibily\/promisifyCleanup<\/a><\/p>\n<p>Codesandbox link:<br \/><a href=\"https:\/\/codesandbox.io\/s\/animationend-fiddle-o2scuh?file=\/src\/index.ts\">https:\/\/codesandbox.io\/s\/animationend-fiddle-o2scuh?file=\/src\/index.ts<\/a><\/p>\n<p>Note: codesandbox link builds on top of the idea above by passing in both the resolve, reject Promise executor to the promisify function allowing the caller to choose whether they want to resolve or reject the Promise.<\/p>\n<h3>\n  <a name=\"tldr\" href=\"#tldr\"><br \/>\n  <\/a><br \/>\n  TLDR;<br \/>\n<\/h3>\n<ol>\n<li>Convert your asynchronous side-effect functions to return a pair of a Promise and a cleanup function<\/li>\n<li>As we don&#8217;t have Promise.cancel, create your own Promise.race\/any\/all implementation that runs all the cleanup functions in the finally block <\/li>\n<\/ol>\n<p>Aside:<br \/>TIL that there is a difference between animationend and transitionend. <a href=\"https:\/\/stackoverflow.com\/a\/41530600\/6036932\">Thank you Jessica<\/a><\/p>\n<\/p><\/div>\n\n","protected":false},"excerpt":{"rendered":"<p>So I came across this interesting problem dealing with state updates and animations. I wanted to create a utility function that would execute a state update after an animation had finished but with a timeout fallback in case a developer forgot to animate the element. This is useful for React applications where you want to &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"\" href=\"http:\/\/localhost\/wordpress\/promisifying-css-animation-with-timeout-fallback\/\"> <span class=\"screen-reader-text\">Promisifying CSS animation with timeout fallback<\/span> Read More &raquo;<\/a><\/p>\n","protected":false},"author":1,"featured_media":1396,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":""},"categories":[1],"tags":[],"_links":{"self":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/posts\/1392"}],"collection":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/comments?post=1392"}],"version-history":[{"count":0,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/posts\/1392\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/media\/1396"}],"wp:attachment":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/media?parent=1392"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/categories?post=1392"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/tags?post=1392"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}