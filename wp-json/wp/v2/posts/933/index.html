{"id":933,"date":"2022-03-09T10:27:17","date_gmt":"2022-03-09T10:27:17","guid":{"rendered":"http:\/\/localhost\/wordpress\/graphql-subscriptions-at-scale-with-nats\/"},"modified":"2022-03-09T10:27:17","modified_gmt":"2022-03-09T10:27:17","slug":"graphql-subscriptions-at-scale-with-nats","status":"publish","type":"post","link":"http:\/\/localhost\/wordpress\/graphql-subscriptions-at-scale-with-nats\/","title":{"rendered":"GraphQL subscriptions at scale with NATS"},"content":{"rendered":"<p> <br \/>\n<\/p>\n<div data-article-id=\"983733\" id=\"article-body\">\n<h3>\n  <a name=\"graphql-subscriptions-at-scale-with-nats\" href=\"#graphql-subscriptions-at-scale-with-nats\"><br \/>\n  <\/a><br \/>\n  GraphQL subscriptions at scale with NATS<br \/>\n<\/h3>\n<p>In this article, we&#8217;ll look at how to setup <a href=\"https:\/\/graphql.org\/\">GraphQL<\/a> subscriptions at scale with <a href=\"https:\/\/nats.io\/\">NATS<\/a>.<\/p>\n<p><em>Note: If you&#8217;re not familiar with NATS, please checkout my <a href=\"https:\/\/dev.to\/karanpratapsingh\/distributed-messaging-with-nats-3jg3\">earlier article<\/a>.<\/em><\/p>\n<h3>\n  <a name=\"why-graphql-subscriptions\" href=\"#why-graphql-subscriptions\"><br \/>\n  <\/a><br \/>\n  Why GraphQL subscriptions?<br \/>\n<\/h3>\n<p>In my opinion, subscriptions are quite underrated and often overlooked. They provide just the right amount of abscraction over websockets, which is both developer friendly and powerful. Plus all the tooling around GraphQL is simply fantastic, from ease of integration to code generators, it&#8217;s the perfect choice to reduce complexity on the frontend.<\/p>\n<h3>\n  <a name=\"what-and-how\" href=\"#what-and-how\"><br \/>\n  <\/a><br \/>\n  What and How?<br \/>\n<\/h3>\n<p>Here, we&#8217;ll create a simple GraphQL server and subscribe to a subject from our resolver. We&#8217;ll use <a href=\"https:\/\/github.com\/graphql\/graphql-playground\">GraphQL playground<\/a> to mock client side behavior. Once we&#8217;re connected we&#8217;ll use NATS CLI to send a payload to our subject and see the changes on the client.<\/p>\n<p><em>Note: NATS client is available in over 40 different <a href=\"https:\/\/nats.io\/download\/#clients\">languages<\/a>.<\/em><\/p>\n<p><a href=\"https:\/\/res.cloudinary.com\/practicaldev\/image\/fetch\/s--_rCQN4iB--\/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\/https:\/\/dev-to-uploads.s3.amazonaws.com\/uploads\/articles\/u005osvssv3g4vda3a4p.png\" class=\"article-body-image-wrapper\"><img src=\"https:\/\/res.cloudinary.com\/practicaldev\/image\/fetch\/s--_rCQN4iB--\/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\/https:\/\/dev-to-uploads.s3.amazonaws.com\/uploads\/articles\/u005osvssv3g4vda3a4p.png\" alt=\"architecture\" loading=\"lazy\" width=\"755\" height=\"334\"\/><\/a><\/p>\n<h3>\n  <a name=\"prerequisites\" href=\"#prerequisites\"><br \/>\n  <\/a><br \/>\n  Pre-requisites<br \/>\n<\/h3>\n<p>We will require following tools to run our example, so make sure you have these installed first.<\/p>\n<h3>\n  <a name=\"setup\" href=\"#setup\"><br \/>\n  <\/a><br \/>\n  Setup<br \/>\n<\/h3>\n<p>Let&#8217;s start by setting up a basic GraphQL project using <a href=\"https:\/\/github.com\/99designs\/gqlgen\">gqlgen<\/a> which lets us autogenerate our schema, resolvers and much more.<\/p>\n<p><em>Note: All the code from this article will be available in this <a href=\"https:\/\/github.com\/karanpratapsingh\/tutorials\/tree\/master\/go\/nats-gql\">repo<\/a><\/em><\/p>\n<p>Init a new go module.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ mkdir example\n$ cd example\n$ go mod init example\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Create a new gqlgen project.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ printf '\/\/ +build tools\\npackage tools\\nimport _ \"github.com\/99designs\/gqlgen\"' | gofmt &gt; tools.go\n$ go mod tidy\n$ go run github.com\/99designs\/gqlgen init\n$ printf 'package model' | gofmt &gt; graph\/model\/doc.go\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>This should create the following directory structure<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u251c\u2500\u2500 gqlgen.yml\n\u251c\u2500\u2500 graph\n\u2502   \u251c\u2500\u2500 generated\n\u2502   \u2502   \u2514\u2500\u2500 generated.go\n\u2502   \u251c\u2500\u2500 model\n\u2502   \u2502   \u251c\u2500\u2500 doc.go\n\u2502   \u2502   \u2514\u2500\u2500 models_gen.go\n\u2502   \u251c\u2500\u2500 resolver.go\n\u2502   \u251c\u2500\u2500 schema.graphqls\n\u2502   \u2514\u2500\u2500 schema.resolvers.go\n\u251c\u2500\u2500 server.go\n\u2514\u2500\u2500 tools.go\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Before we run this, let&#8217;s simplify the <code>graph\/schema.graphqls<\/code> as below to keep things as minimal as possible so we can focus on NATS integration more clearly.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight graphql\"><code><span class=\"k\">type<\/span><span class=\"w\"> <\/span><span class=\"n\">Subscription<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">payload<\/span><span class=\"p\">:<\/span><span class=\"w\"> <\/span><span class=\"nb\">String<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"k\">type<\/span><span class=\"w\"> <\/span><span class=\"n\">Query<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">payload<\/span><span class=\"p\">:<\/span><span class=\"w\"> <\/span><span class=\"nb\">String<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Let&#8217;s re-generate our resolvers<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ go run github.com\/99designs\/gqlgen generate\nvalidation failed: packages.Load: nats-gql\/graph\/schema.resolvers.go:36:72: NewTodo not declared by package model\nnats-gql\/graph\/schema.resolvers.go:36:89: Todo not declared by package model\nnats-gql\/graph\/schema.resolvers.go:39:62: Todo not declared by package model\nnats-gql\/graph\/schema.resolvers.go:42:41: MutationResolver not declared by package generated\n\nexit status 1\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>This should give an error, which tells us to remove unused code from our resolvers. To fix this simply open <code>graph\/schema.resolvers.go<\/code> and remove anything below the <code>\/\/ !!! WARNING !!!<\/code> sign.<\/p>\n<p>Now, let&#8217;s also change the query resolver <code>Payload<\/code>.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight go\"><code><span class=\"k\">func<\/span> <span class=\"p\">(<\/span><span class=\"n\">r<\/span> <span class=\"o\">*<\/span><span class=\"n\">queryResolver<\/span><span class=\"p\">)<\/span> <span class=\"n\">Payload<\/span><span class=\"p\">(<\/span><span class=\"n\">ctx<\/span> <span class=\"n\">context<\/span><span class=\"o\">.<\/span><span class=\"n\">Context<\/span><span class=\"p\">)<\/span> <span class=\"p\">(<\/span><span class=\"o\">*<\/span><span class=\"kt\">string<\/span><span class=\"p\">,<\/span> <span class=\"kt\">error<\/span><span class=\"p\">)<\/span> <span class=\"p\">{<\/span>\n    <span class=\"n\">value<\/span> <span class=\"o\">:=<\/span> <span class=\"s\">\"hello world\"<\/span>\n    <span class=\"k\">return<\/span> <span class=\"o\">&amp;<\/span><span class=\"n\">value<\/span><span class=\"p\">,<\/span> <span class=\"no\">nil<\/span>\n<span class=\"p\">}<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>And finally let&#8217;s run the server!<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ go run server.go\n2022\/02\/15 18:20:56 connect to http:\/\/localhost:8080\/ for GraphQL playground\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Wohoo! Now we can go to <code>localhost:8080<\/code> and run our sample query in GraphQL playground and it should give us a result.<br \/><a href=\"https:\/\/res.cloudinary.com\/practicaldev\/image\/fetch\/s--cCOBhWEa--\/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\/https:\/\/dev-to-uploads.s3.amazonaws.com\/uploads\/articles\/py10so016qcb4tbks16a.png\" class=\"article-body-image-wrapper\"><img src=\"https:\/\/res.cloudinary.com\/practicaldev\/image\/fetch\/s--cCOBhWEa--\/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\/https:\/\/dev-to-uploads.s3.amazonaws.com\/uploads\/articles\/py10so016qcb4tbks16a.png\" alt=\"query\" loading=\"lazy\" width=\"880\" height=\"443\"\/><\/a><\/p>\n<p>Now that we have our basic GraphQL server working, let&#8217;s look into our subscription resolver defined in <code>schema.resolvers.go<\/code>.<\/p>\n<p>But first, let&#8217;s understand the <code>Payload<\/code> resolver function. As we know, Go has this amazing concept of channels and if we look at the return signature this function requires us to return a <a href=\"https:\/\/www.sohamkamani.com\/golang\/channels\/\"><em>receive only channel<\/em><\/a> of type <code>*string<\/code> along with <code>error<\/code> in case something goes wrong. This seems quite idiomatic Go to me!<\/p>\n<p><em>Note: gqlgen will forward any data sent to this channel to the subcription.<\/em><\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight go\"><code><span class=\"k\">func<\/span> <span class=\"p\">(<\/span><span class=\"n\">r<\/span> <span class=\"o\">*<\/span><span class=\"n\">subscriptionResolver<\/span><span class=\"p\">)<\/span> <span class=\"n\">Payload<\/span><span class=\"p\">(<\/span><span class=\"n\">ctx<\/span> <span class=\"n\">context<\/span><span class=\"o\">.<\/span><span class=\"n\">Context<\/span><span class=\"p\">)<\/span> <span class=\"p\">(<\/span><span class=\"o\">&lt;-<\/span><span class=\"k\">chan<\/span> <span class=\"o\">*<\/span><span class=\"kt\">string<\/span><span class=\"p\">,<\/span> <span class=\"kt\">error<\/span><span class=\"p\">)<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p><em>Note: Notice that <code>*string<\/code> will be changed if we update our schema and regenerate our resolvers<\/em><\/p>\n<p>This is perfect! Let&#8217;s install <a href=\"https:\/\/github.com\/nats-io\/nats.go\"><code>nats.go<\/code><\/a>.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ go get github.com\/nats-io\/nats.go\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>gqlgen is setup in such a way that it makes it very easy to do dependency injection. So, let&#8217;s init our NATS client. But first let&#8217;s update some types.<\/p>\n<p>In <code>graph\/resolver.go<\/code> update the <code>Resolver<\/code> type as below.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight go\"><code><span class=\"k\">type<\/span> <span class=\"n\">Resolver<\/span> <span class=\"k\">struct<\/span><span class=\"p\">{<\/span>\n    <span class=\"n\">Nats<\/span> <span class=\"o\">*<\/span><span class=\"n\">nats<\/span><span class=\"o\">.<\/span><span class=\"n\">Conn<\/span>\n<span class=\"p\">}<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Nice! now we&#8217;ll be able to init and pass our client to <code>graph.Resolver<\/code> struct in <code>server.go<\/code>.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight go\"><code><span class=\"n\">nc<\/span><span class=\"p\">,<\/span> <span class=\"n\">err<\/span> <span class=\"o\">:=<\/span> <span class=\"n\">nats<\/span><span class=\"o\">.<\/span><span class=\"n\">Connect<\/span><span class=\"p\">(<\/span><span class=\"n\">nats<\/span><span class=\"o\">.<\/span><span class=\"n\">DefaultURL<\/span><span class=\"p\">)<\/span>\n\n<span class=\"k\">if<\/span> <span class=\"n\">err<\/span> <span class=\"o\">!=<\/span> <span class=\"no\">nil<\/span> <span class=\"p\">{<\/span>\n    <span class=\"nb\">panic<\/span><span class=\"p\">(<\/span><span class=\"n\">err<\/span><span class=\"p\">)<\/span>\n<span class=\"p\">}<\/span>\n\n<span class=\"k\">defer<\/span> <span class=\"n\">nc<\/span><span class=\"o\">.<\/span><span class=\"n\">Close<\/span><span class=\"p\">()<\/span>\n\n<span class=\"n\">srv<\/span> <span class=\"o\">:=<\/span> <span class=\"n\">handler<\/span><span class=\"o\">.<\/span><span class=\"n\">NewDefaultServer<\/span><span class=\"p\">(<\/span><span class=\"n\">generated<\/span><span class=\"o\">.<\/span><span class=\"n\">NewExecutableSchema<\/span><span class=\"p\">(<\/span><span class=\"n\">generated<\/span><span class=\"o\">.<\/span><span class=\"n\">Config<\/span><span class=\"p\">{<\/span><span class=\"n\">Resolvers<\/span><span class=\"o\">:<\/span> <span class=\"o\">&amp;<\/span><span class=\"n\">graph<\/span><span class=\"o\">.<\/span><span class=\"n\">Resolver<\/span><span class=\"p\">{<\/span><span class=\"n\">nc<\/span><span class=\"p\">}}))<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Great! moving back to <code>graph\/schema_resolvers.go<\/code> let&#8217;s define a channel and subscribe to a subject like <code>payload-subject<\/code>. In the callback function, we&#8217;ll simply convert our message data which is a byte array to string and send it to our channel.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight go\"><code><span class=\"k\">func<\/span> <span class=\"p\">(<\/span><span class=\"n\">r<\/span> <span class=\"o\">*<\/span><span class=\"n\">subscriptionResolver<\/span><span class=\"p\">)<\/span> <span class=\"n\">Payload<\/span><span class=\"p\">(<\/span><span class=\"n\">ctx<\/span> <span class=\"n\">context<\/span><span class=\"o\">.<\/span><span class=\"n\">Context<\/span><span class=\"p\">)<\/span> <span class=\"p\">(<\/span><span class=\"o\">&lt;-<\/span><span class=\"k\">chan<\/span> <span class=\"o\">*<\/span><span class=\"kt\">string<\/span><span class=\"p\">,<\/span> <span class=\"kt\">error<\/span><span class=\"p\">)<\/span> <span class=\"p\">{<\/span>\n    <span class=\"n\">ch<\/span> <span class=\"o\">:=<\/span> <span class=\"nb\">make<\/span><span class=\"p\">(<\/span><span class=\"k\">chan<\/span> <span class=\"o\">*<\/span><span class=\"kt\">string<\/span><span class=\"p\">)<\/span>\n\n    <span class=\"n\">r<\/span><span class=\"o\">.<\/span><span class=\"n\">Nats<\/span><span class=\"o\">.<\/span><span class=\"n\">Subscribe<\/span><span class=\"p\">(<\/span><span class=\"s\">\"payload-subject\"<\/span><span class=\"p\">,<\/span> <span class=\"k\">func<\/span><span class=\"p\">(<\/span><span class=\"n\">msg<\/span> <span class=\"o\">*<\/span><span class=\"n\">nats<\/span><span class=\"o\">.<\/span><span class=\"n\">Msg<\/span><span class=\"p\">)<\/span> <span class=\"p\">{<\/span>\n        <span class=\"n\">payload<\/span> <span class=\"o\">:=<\/span> <span class=\"kt\">string<\/span><span class=\"p\">(<\/span><span class=\"n\">msg<\/span><span class=\"o\">.<\/span><span class=\"n\">Data<\/span><span class=\"p\">)<\/span>\n        <span class=\"n\">ch<\/span> <span class=\"o\">&lt;-<\/span> <span class=\"o\">&amp;<\/span><span class=\"n\">payload<\/span>\n    <span class=\"p\">})<\/span>\n\n    <span class=\"k\">return<\/span> <span class=\"n\">ch<\/span><span class=\"p\">,<\/span> <span class=\"no\">nil<\/span>\n<span class=\"p\">}<\/span>\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p><em>Note: You can easily setup an <a href=\"https:\/\/docs.nats.io\/using-nats\/developer\/sending\/structure\">encoded connection<\/a> to auto-parse any json data. NATS makes it super convenient!<\/em><\/p>\n<p>Before we run our app, let&#8217;s open a new terminal window and start our NATS server.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ nats-server\n[17275] 2022\/02\/15 18:57:30.517959 [INF] Starting nats-server\n[17275] 2022\/02\/15 18:57:30.518427 [INF]   Version:  2.7.0\n[17275] 2022\/02\/15 18:57:30.518431 [INF]   Git:      [not set]\n[17275] 2022\/02\/15 18:57:30.518439 [INF]   Name:     NDR3HVHJHVJKXIAIXYZWLUEYTEG6MRSOSCHLW2QXEKA2GSZ2JKBTI3DA\n[17275] 2022\/02\/15 18:57:30.518442 [INF]   ID:       NDR3HVHJHVJKXIAIXYZWLUEYTEG6MRSOSCHLW2QXEKA2GSZ2JKBTI3DA\n[17275] 2022\/02\/15 18:57:30.521185 [INF] Listening for client connections on 0.0.0.0:4222\n[17275] 2022\/02\/15 18:57:30.521621 [INF] Server is read\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p><em>Note: Want to run NATS in production? Checkout my ealier article where we look at different ways of running a <a href=\"https:\/\/dev.to\/karanpratapsingh\/nats-with-kubernetes-3bmc\">NATS server on Kubernetes<\/a>.<\/em><\/p>\n<p>Finally! Let&#8217;s start our app and navigate to <code>localhost:8080<\/code><\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ go run server.go\n2022\/02\/15 19:03:22 connect to http:\/\/localhost:8080\/ for GraphQL playground\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Let&#8217;s start a subscription for a query.<\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight graphql\"><code><span class=\"k\">subscription<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">payload<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p>Now it should be actively listening for changes. Lastly, let&#8217;s publish a message, usually this will be performed by a another service or client but right now we can just use the nats cli. i.e <code>nats pub &lt;subject&gt; &lt;payload&gt;<\/code><\/p>\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>$ nats pub payload-subject \"hello world\"\n<\/code><\/pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode<\/title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\/>\n<\/svg><\/p>\n<p>    <svg xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode<\/title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\/>\n<\/svg><\/p>\n<\/div>\n<\/div>\n<\/div>\n<p><a href=\"https:\/\/res.cloudinary.com\/practicaldev\/image\/fetch\/s--EG2f5Xw9--\/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880\/https:\/\/dev-to-uploads.s3.amazonaws.com\/uploads\/articles\/3g001txcm9elgr7pomhu.gif\" class=\"article-body-image-wrapper\"><img src=\"https:\/\/res.cloudinary.com\/practicaldev\/image\/fetch\/s--EG2f5Xw9--\/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880\/https:\/\/dev-to-uploads.s3.amazonaws.com\/uploads\/articles\/3g001txcm9elgr7pomhu.gif\" alt=\"nats-subscription\" loading=\"lazy\" width=\"880\" height=\"412\" data-animated=\"true\"\/><\/a><\/p>\n<h3>\n  <a name=\"conclusion\" href=\"#conclusion\"><br \/>\n  <\/a><br \/>\n  Conclusion<br \/>\n<\/h3>\n<p>Perfect! Now we can run our real time GraphQL subscriptions at scale, all thanks to NATS which is capable of serving upto 18 million messages per second (yes, you read that right!). I hope this article was helpful, as always if you have any questions feel free to reachout to me on <a href=\"https:\/\/www.linkedin.com\/in\/karan99\/\">LinkedIn<\/a> or <a href=\"https:\/\/twitter.com\/karan_6864\">Twitter<\/a>.<\/p>\n<\/p><\/div>\n<p><script async src=\"\/\/platform.twitter.com\/widgets.js\" charset=\"utf-8\"><\/script><br \/>\n<br \/><\/p>\n","protected":false},"excerpt":{"rendered":"<p>GraphQL subscriptions at scale with NATS In this article, we&#8217;ll look at how to setup GraphQL subscriptions at scale with NATS. Note: If you&#8217;re not familiar with NATS, please checkout my earlier article. Why GraphQL subscriptions? In my opinion, subscriptions are quite underrated and often overlooked. They provide just the right amount of abscraction over &hellip;<\/p>\n<p class=\"read-more\"> <a class=\"\" href=\"http:\/\/localhost\/wordpress\/graphql-subscriptions-at-scale-with-nats\/\"> <span class=\"screen-reader-text\">GraphQL subscriptions at scale with NATS<\/span> Read More &raquo;<\/a><\/p>\n","protected":false},"author":1,"featured_media":934,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"site-sidebar-layout":"default","site-content-layout":"default","ast-main-header-display":"","ast-hfb-above-header-display":"","ast-hfb-below-header-display":"","ast-hfb-mobile-header-display":"","site-post-title":"","ast-breadcrumbs-content":"","ast-featured-img":"","footer-sml-layout":"","theme-transparent-header-meta":"","adv-header-id-meta":"","stick-header-meta":"","header-above-stick-meta":"","header-main-stick-meta":"","header-below-stick-meta":""},"categories":[1],"tags":[],"_links":{"self":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/posts\/933"}],"collection":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/comments?post=933"}],"version-history":[{"count":0,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/posts\/933\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/media\/934"}],"wp:attachment":[{"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/media?parent=933"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/categories?post=933"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/localhost\/wordpress\/wp-json\/wp\/v2\/tags?post=933"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}